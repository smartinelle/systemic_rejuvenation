#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const { execSync } = require('child_process');

function sha256(buf) {
  return crypto.createHash('sha256').update(buf).digest('hex');
}

function tryGitSha(repoRoot) {
  try {
    // Prefer the last commit that touched the model directory, so UI-only commits
    // donâ€™t cause the manifest to change unnecessarily.
    return execSync('git rev-list -1 HEAD -- src/aging_network', {
      cwd: repoRoot,
      stdio: ['ignore', 'pipe', 'ignore'],
    })
      .toString()
      .trim();
  } catch {
    return null;
  }
}

function ensureDir(dirPath) {
  fs.mkdirSync(dirPath, { recursive: true });
}

function rmDir(dirPath) {
  if (!fs.existsSync(dirPath)) return;
  fs.rmSync(dirPath, { recursive: true, force: true });
}

function writeFileAtomic(filePath, content) {
  ensureDir(path.dirname(filePath));
  const tmpPath = `${filePath}.tmp-${process.pid}`;
  fs.writeFileSync(tmpPath, content);
  fs.renameSync(tmpPath, filePath);
}

function generateWebSafeInitPy() {
  return `"""Aging network model (web bundle).

This file is generated by web/scripts/sync-aging-network-model.js.
It intentionally avoids importing plotting utilities (matplotlib) because the web
UI renders charts in JavaScript.
"""

from .config import (
    DEFAULT_SCENARIOS,
    SimulationConfig,
    SystemConfig,
    default_intervention_config,
    default_simulation_config,
    default_system_config,
)
from .simulation import SimulationResult, run_all_scenarios, run_many, run_sim

__all__ = [
    "DEFAULT_SCENARIOS",
    "SimulationConfig",
    "SystemConfig",
    "SimulationResult",
    "default_simulation_config",
    "default_system_config",
    "default_intervention_config",
    "run_sim",
    "run_many",
    "run_all_scenarios",
]
`;
}

function main() {
  const webDir = path.resolve(__dirname, '..');
  const repoRoot = path.resolve(webDir, '..');
  const srcDir = path.resolve(repoRoot, 'src', 'aging_network');
  const outRoot = path.resolve(webDir, 'public', 'py');
  const outPkgDir = path.resolve(outRoot, 'aging_network');
  const manifestPath = path.resolve(outRoot, 'model-manifest.json');

  const coreFiles = ['config.py', 'model.py', 'interventions.py', 'simulation.py'];

  if (!fs.existsSync(srcDir)) {
    console.error(`Expected source model directory not found: ${srcDir}`);
    process.exit(1);
  }

  rmDir(outPkgDir);
  ensureDir(outPkgDir);

  const manifest = {
    source: {
      path: 'src/aging_network',
      gitSha: tryGitSha(repoRoot),
    },
    bundle: {
      path: 'web/public/py/aging_network',
      files: [],
    },
  };

  for (const filename of coreFiles) {
    const srcPath = path.resolve(srcDir, filename);
    const destPath = path.resolve(outPkgDir, filename);
    const content = fs.readFileSync(srcPath);
    writeFileAtomic(destPath, content);
    manifest.bundle.files.push({
      path: `aging_network/${filename}`,
      sha256: sha256(content),
      bytes: content.byteLength,
      source: `src/aging_network/${filename}`,
      generated: false,
    });
  }

  const initContent = Buffer.from(generateWebSafeInitPy(), 'utf8');
  writeFileAtomic(path.resolve(outPkgDir, '__init__.py'), initContent);
  manifest.bundle.files.push({
    path: 'aging_network/__init__.py',
    sha256: sha256(initContent),
    bytes: initContent.byteLength,
    source: 'generated',
    generated: true,
    note: 'Web-safe shim (excludes plotting/matplotlib imports).',
  });

  writeFileAtomic(manifestPath, Buffer.from(`${JSON.stringify(manifest, null, 2)}\n`, 'utf8'));

  const relOut = path.relative(repoRoot, outPkgDir);
  console.log(`Synced aging_network model bundle to ${relOut}`);
}

main();
