#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

function sha256(buf) {
  return crypto.createHash('sha256').update(buf).digest('hex');
}

function generateWebSafeInitPy() {
  return `"""Aging network model (web bundle).

This file is generated by web/scripts/sync-aging-network-model.js.
It intentionally avoids importing plotting utilities (matplotlib) because the web
UI renders charts in JavaScript.
"""

from .config import (
    DEFAULT_SCENARIOS,
    SimulationConfig,
    SystemConfig,
    default_intervention_config,
    default_simulation_config,
    default_system_config,
)
from .simulation import SimulationResult, run_all_scenarios, run_many, run_sim

__all__ = [
    "DEFAULT_SCENARIOS",
    "SimulationConfig",
    "SystemConfig",
    "SimulationResult",
    "default_simulation_config",
    "default_system_config",
    "default_intervention_config",
    "run_sim",
    "run_many",
    "run_all_scenarios",
]
`;
}

function main() {
  const webDir = path.resolve(__dirname, '..');
  const repoRoot = path.resolve(webDir, '..');
  const srcDir = path.resolve(repoRoot, 'src', 'aging_network');
  const outRoot = path.resolve(webDir, 'public', 'py');
  const outPkgDir = path.resolve(outRoot, 'aging_network');
  const manifestPath = path.resolve(outRoot, 'model-manifest.json');

  const coreFiles = ['config.py', 'model.py', 'interventions.py', 'simulation.py'];

  const problems = [];

  for (const filename of coreFiles) {
    const srcPath = path.resolve(srcDir, filename);
    const destPath = path.resolve(outPkgDir, filename);
    if (!fs.existsSync(destPath)) {
      problems.push(`Missing bundled file: web/public/py/aging_network/${filename}`);
      continue;
    }
    const srcContent = fs.readFileSync(srcPath);
    const destContent = fs.readFileSync(destPath);
    if (!destContent.equals(srcContent)) {
      problems.push(`Out of sync: ${filename}`);
    }
  }

  const initPath = path.resolve(outPkgDir, '__init__.py');
  const expectedInit = Buffer.from(generateWebSafeInitPy(), 'utf8');
  if (!fs.existsSync(initPath)) {
    problems.push('Missing bundled file: web/public/py/aging_network/__init__.py');
  } else {
    const actualInit = fs.readFileSync(initPath);
    if (!actualInit.equals(expectedInit)) {
      problems.push('Out of sync: __init__.py (expected generated web-safe shim)');
    }
  }

  if (!fs.existsSync(manifestPath)) {
    problems.push('Missing manifest: web/public/py/model-manifest.json');
  } else {
    try {
      const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
      const manifestFiles = Array.isArray(manifest?.bundle?.files) ? manifest.bundle.files : null;
      if (!manifestFiles) {
        problems.push('Invalid manifest: missing bundle.files');
      } else {
        const byPath = new Map(manifestFiles.map((f) => [f.path, f]));
        for (const filename of coreFiles) {
          const rel = `aging_network/${filename}`;
          const entry = byPath.get(rel);
          if (!entry) {
            problems.push(`Manifest missing entry: ${rel}`);
            continue;
          }
          const srcContent = fs.readFileSync(path.resolve(srcDir, filename));
          const srcHash = sha256(srcContent);
          if (entry.sha256 !== srcHash) {
            problems.push(`Manifest hash mismatch for ${rel}`);
          }
        }
      }
    } catch (err) {
      problems.push(`Invalid manifest JSON: ${String(err)}`);
    }
  }

  if (problems.length) {
    console.error('aging_network web bundle is out of sync with src/aging_network:');
    for (const p of problems) console.error(`- ${p}`);
    console.error('\nRun: node web/scripts/sync-aging-network-model.js');
    process.exit(1);
  }

  console.log('aging_network web bundle is in sync.');
}

main();

